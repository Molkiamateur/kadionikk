#include <stdio.h>
#include <stdlib.h>
#include <system.h>
#include <time.h>
#include <unistd.h>
#include <alt_types.h>
#include <io.h>
#include "includes.h"
#include "altera_up_avalon_video_dma_controller.h"

#include "bsp.h"
#include "vgalib.h"

/* Definition of Task Stacks */
#define   TASK_STACKSIZE       2048
OS_STK    task1_stk[TASK_STACKSIZE];

/* Definition of Task Priorities */
#define TASK1_PRIORITY      1

int min(int a, int b){
	return a < b ? a : b;
}
void task_rect(void* pdata){
	int x1,x2,y1,y2;
	short pixel_color;
	char r,g,b;

	while (1){
		x1 = rand()%320;
		x2 = min(x1 + rand() % 320, 319);
		y1 = rand() % 240;
		y2 = min(y1 + rand() % 240,239);
		r = rand() % 64;
		g = rand() % 128;
		b = rand() % 64;
		pixel_color =  (r << 11) + (g << 5) + b;
		VgaDrawBox(x1, y1, x2, y2, pixel_color);
		OSTimeDly(2000);
	}
}

int main(void){

  BSP_init();

  VgaClearScreen();
  VgaInit();

  OSTaskCreateExt(task_rect,
                  NULL,
                  (void *)&task1_stk[TASK_STACKSIZE-1],
                  TASK1_PRIORITY,
                  TASK1_PRIORITY,
                  task1_stk,
                  TASK_STACKSIZE,
                  NULL,
                  0);

  OSStart();
  return 0;
}
